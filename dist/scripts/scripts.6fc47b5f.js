"use strict";angular.module("thisDayApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","firebase","firebase.ref","firebase.auth","angularMoment","ngMaterial"]).config(["$sceDelegateProvider",function(a){a.resourceUrlWhitelist(["self","https://upload.wikimedia.org/**"])}]),angular.module("thisDayApp").controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("firebase.config",[]).constant("FBURL","https://thisdaywiki.firebaseio.com").constant("SIMPLE_LOGIN_PROVIDERS",["password","anonymous"]).constant("loginRedirectPath","/login"),angular.module("firebase.ref",["firebase","firebase.config"]).factory("Ref",["$window","FBURL",function(a,b){return new a.Firebase(b)}]),angular.module("thisDayApp").controller("ChatCtrl",["$scope","Ref","$firebaseArray","$timeout",function(a,b,c,d){function e(b){a.err=b,d(function(){a.err=null},5e3)}a.messages=c(b.child("messages").limitToLast(10)),a.messages.$loaded()["catch"](e),a.addMessage=function(b){b&&a.messages.$add({text:b})["catch"](e)}}]),angular.module("thisDayApp").filter("reverse",function(){return function(a){return angular.isArray(a)?a.slice().reverse():[]}}),function(){angular.module("firebase.auth",["firebase","firebase.ref"]).factory("Auth",["$firebaseAuth","Ref",function(a,b){return a(b)}])}(),angular.module("thisDayApp").controller("LoginCtrl",["$scope","Auth","$location","$q","Ref","$timeout",function(a,b,c,d,e,f){function g(a){return h(a.substr(0,a.indexOf("@"))||"")}function h(a){a+="";var b=a.charAt(0).toUpperCase();return b+a.substr(1)}function i(){c.path("/account")}function j(b){a.err=b}a.oauthLogin=function(c){a.err=null,b.$authWithOAuthPopup(c,{rememberMe:!0}).then(i,j)},a.anonymousLogin=function(){a.err=null,b.$authAnonymously({rememberMe:!0}).then(i,j)},a.passwordLogin=function(c,d){a.err=null,b.$authWithPassword({email:c,password:d},{rememberMe:!0}).then(i,j)},a.createAccount=function(c,h,k){function l(a){var b=e.child("users",a.uid),h=d.defer();return b.set({email:c,name:g(c)},function(a){f(function(){a?h.reject(a):h.resolve(b)})}),h.promise}a.err=null,h?h!==k?a.err="Passwords do not match":b.$createUser({email:c,password:h}).then(function(){return b.$authWithPassword({email:c,password:h},{rememberMe:!0})}).then(l).then(i,j):a.err="Please enter a password"}}]),angular.module("thisDayApp").controller("AccountCtrl",["$scope","user","Auth","Ref","$firebaseObject","$timeout",function(a,b,c,d,e,f){function g(a){i(a,"danger")}function h(a){i(a,"success")}function i(b,c){var d={text:b+"",type:c};a.messages.unshift(d),f(function(){a.messages.splice(a.messages.indexOf(d),1)},1e4)}a.user=b,a.logout=function(){c.$unauth()},a.messages=[];var j=e(d.child("users/"+b.uid));j.$bindTo(a,"profile"),a.changePassword=function(b,d,e){a.err=null,b&&d?d!==e?g("Passwords do not match"):c.$changePassword({email:j.email,oldPassword:b,newPassword:d}).then(function(){h("Password changed")},g):g("Please enter all fields")},a.changeEmail=function(b,d){a.err=null,c.$changeEmail({password:b,newEmail:d,oldEmail:j.email}).then(function(){j.email=d,j.$save(),h("Email changed")})["catch"](g)}}]),angular.module("thisDayApp").directive("ngShowAuth",["Auth","$timeout",function(a,b){return{restrict:"A",link:function(c,d){function e(){b(function(){d.toggleClass("ng-cloak",!a.$getAuth())},0)}d.addClass("ng-cloak"),a.$onAuth(e),e()}}}]),angular.module("thisDayApp").directive("ngHideAuth",["Auth","$timeout",function(a,b){return{restrict:"A",link:function(c,d){function e(){b(function(){d.toggleClass("ng-cloak",!!a.$getAuth())},0)}d.addClass("ng-cloak"),a.$onAuth(e),e()}}}]),angular.module("thisDayApp").config(["$routeProvider","SECURED_ROUTES",function(a,b){a.whenAuthenticated=function(c,d){return d.resolve=d.resolve||{},d.resolve.user=["Auth",function(a){return a.$requireAuth()}],a.when(c,d),b[c]=!0,a}}]).config(["$routeProvider",function(a){a.when("/chat",{templateUrl:"views/chat.html",controller:"ChatCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).whenAuthenticated("/account",{templateUrl:"views/account.html",controller:"AccountCtrl"}).when("/day/:month?/:day?",{templateUrl:"views/day.html",controller:"DayCtrl"}).otherwise({redirectTo:"/day"})}]).run(["$rootScope","$location","Auth","SECURED_ROUTES","loginRedirectPath",function(a,b,c,d,e){function f(a){!a&&g(b.path())&&b.path(e)}function g(a){return d.hasOwnProperty(a)}c.$onAuth(f),a.$on("$routeChangeError",function(a,c,d,f){"AUTH_REQUIRED"===f&&b.path(e)})}]).constant("SECURED_ROUTES",{}),angular.module("thisDayApp").controller("DayCtrl",["$scope","$routeParams","wikiQuery","$timeout",function(a,b,c,d){var e,f,g,h,i;b.month&&b.day?(f=parseInt(b.month),g=moment().month(f-1).format("MMMM"),h=b.day,e=g+"_"+b.day):(b.month=moment().format("MM"),e=moment().format("MMMM_D")),a.dateToDisplay=e.replace("_"," ");var j="2",k=function(){c.personFromList(i).then(function(b){d(function(){a.person=b},250)})},l=function(){a.dateToDisplay=e.replace("_"," "),delete a.person,c.getList(e,j).then(function(a){i=a,k()})};l(),a.refresh=function(){delete a.person,k()},a.previousDay=function(){e=moment(e,"MMMM_D").subtract(1,"days").format("MMMM_D"),l()},a.nextDay=function(){e=moment(e,"MMMM_D").add(1,"days").format("MMMM_D"),l()}}]),angular.module("thisDayApp").factory("wikiQuery",["$http","$q",function(a,b){var c="https://en.wikipedia.org/w/api.php?",d=function(a){return Math.floor(Math.random()*a+1)},e=function(a){var b=angular.element(a).find("li"),c=[];return b.map(function(a){var d=angular.element(b[a]),e={};e.name=getTextOfNodeType(d,1),e.description=getTextOfNodeType(d,3),e.link=d.attr("href"),c.push(e)}),c},f=function(d,f){var g=b.defer(),h={action:"parse",page:d,prop:"text",section:f,format:"json",callback:"JSON_CALLBACK"};return a({method:"jsonp",url:c,params:h}).then(function(a){var b;if(!a.data.parse)return void console.error("Invalid query!");b=a.data.parse.text["*"];var c=angular.element(b).find("li"),d=[];angular.forEach(c,function(a,b){var c,f,g,h=angular.element(a),i=[],j=h.text().split(" â€“ ");if(h.children("ul").length>0)return void e(h.children("ul").first()).forEach(function(a){d.push({year:j[0],name:a.name,link:a.link})});if(j[1]){j[1].split(", ");angular.forEach(h.children("a"),function(a,b){var c=angular.element(a);i.push(c.text())}),i[0]!==j[0]?(c=j[0],f=h.children("a").first().text(),g=h.children("a").first().attr("href")):(c=h.children("a").eq(0).text(),f=h.children("a").eq(1).text(),g=h.children("a").eq(1).attr("href")),d.push({year:c,name:f,link:g})}}),g.resolve(d)}),g.promise},g=function(d){var e,f=b.defer(),g={action:"query",titles:d,prop:"imageinfo",iiprop:"url",format:"json",callback:"JSON_CALLBACK"};return a({method:"jsonp",url:c,params:g}).then(function(a){var b,c=a.data.query;c&&c.pages&&(b=Object.keys(c.pages),e=c.pages[b[0]].imageinfo[0].url),f.resolve(e)}),f.promise},h=function(d){var e=b.defer(),f=d.name.split(" ");f[1];d.link||(d.link=d.name.replace(" ","_"));var h={action:"query",titles:d.link,prop:"images",format:"json",callback:"JSON_CALLBACK"};return a({method:"jsonp",url:c,params:h}).then(function(a){var b,c=a.data.query,d=!0;if(c&&c.pages)for(var h in c.pages)c.pages[h].images&&c.pages[h].images.forEach(function(a){d&&(b||-1!==a.title.indexOf("svg")||(b=a.title),f.forEach(function(c){return a.title.indexOf(c)>-1?(b=a.title,void(d=!1)):void 0}))});g(b).then(function(a){e.resolve(a)},function(){e.resolve()})}),e.promise},i=function(e){for(var f,g,i=b.defer();!f;)g=d(e.length),f=e[g];f.link?f.link=f.link.replace("/wiki/",""):f.link=f.name.replace(" ","_"),console.log(f);var j={action:"query",titles:decodeURIComponent(f.link),prop:"extracts",exinfo:"",exsentences:"3",explaintext:"",format:"json",callback:"JSON_CALLBACK"};return a({method:"jsonp",url:c,params:j}).then(function(a){var b,c=a.data.query.pages,d=Object.keys(c),e=c[d[0]];if(e.extract){b=e.extract.indexOf("=")>-1?e.extract.substring(0,e.extract.indexOf("=")):e.extract;var g={name:f.name,year:f.year,pageId:e.pageid,about:b,link:f.link};h(f).then(function(a){a&&(g.imageUrl=a),i.resolve(g)})}else i.reject()}),i.promise},j={};return j.getList=function(a,c){var d=b.defer();return f(a,c).then(function(a){d.resolve(a)}),d.promise},j.personFromList=function(a){var c=b.defer();return i(a).then(function(a){c.resolve(a)},function(){}),c.promise},j.getRandomPerson=function(a,c){var d,e,g=b.defer();return d=f(a,c),e=d.then(function(a){return i(a)}),e.then(function(a){g.resolve(a)}),g.promise},j}]),angular.module("thisDayApp").directive("showDate",["$location",function(a){return{template:"<div></div>",restrict:"E",link:function(a,b,c){var d;d=moment().format("MMMM Do"),b.text(d)}}}]);